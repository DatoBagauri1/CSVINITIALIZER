{% extends 'base.html' %}

{% block content %}
<div class="min-h-screen relative">
    <nav class="gradient-bg border-b border-gray-800">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/" class="text-2xl font-bold neon-text" style="color: var(--neon-blue);">CSV Analyzer</a>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-300">My Charts</span>
                    <a href="{% url 'my_files' %}" 
                       class="px-4 py-2 gradient-bg border border-neon-blue rounded-lg hover:border-neon-blue transition-all duration-300">
                        My Files
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2 neon-text" style="color: var(--neon-blue);">My Charts</h1>
                <p class="text-gray-400">{{ total_charts }} chart{{ total_charts|pluralize }} created</p>
            </div>
            <div class="flex space-x-3">
                <a href="/" 
                   class="px-6 py-3 bg-gradient-to-r from-neon-blue to-neon-purple rounded-lg font-bold hover:scale-105 transition-transform duration-300">
                    + New Analysis
                </a>
            </div>
        </div>

        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-500/20 border border-green-500 text-green-300{% else %}bg-red-500/20 border border-red-500 text-red-300{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if charts %}
        <!-- Filter Options -->
        <div class="gradient-bg rounded-xl p-4 mb-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <select id="sessionFilter" class="w-full gradient-bg border border-gray-700 rounded-lg p-3">
                        <option value="">All Sessions</option>
                        {% for session in sessions %}
                        <option value="{{ session.id }}">{{ session.csv_file.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <select id="typeFilter" class="w-full gradient-bg border border-gray-700 rounded-lg p-3">
                        <option value="">All Chart Types</option>
                        <option value="bar">Bar Charts</option>
                        <option value="line">Line Charts</option>
                        <option value="pie">Pie Charts</option>
                        <option value="histogram">Histograms</option>
                    </select>
                </div>
                <button onclick="clearFilters()" 
                        class="px-4 py-3 gradient-bg border border-gray-700 rounded-lg hover:border-neon-blue transition-all duration-300">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="chartsContainer">
            {% for chart in charts %}
            <div class="gradient-bg rounded-xl p-4 hover:scale-[1.02] transition-transform duration-300 chart-card" 
                 data-session="{{ chart.session.id }}" data-type="{{ chart.chart_type }}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h3 class="font-bold text-lg mb-1">{{ chart.title }}</h3>
                        <p class="text-sm text-gray-400">
                            From: {{ chart.session.csv_file.name }}
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="px-2 py-1 bg-gray-800 rounded text-xs">
                            {{ chart.chart_type|title }}
                        </span>
                        <button onclick="showDeleteModal({{ chart.id }}, '{{ chart.title|escapejs }}')" 
                                class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center hover:bg-red-500 transition-colors duration-300">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
                
                <div class="h-40 mb-4 rounded-lg bg-gray-900/50 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-4xl mb-2">
                            {% if chart.chart_type == 'bar' %}ğŸ“Š
                            {% elif chart.chart_type == 'line' %}ğŸ“ˆ
                            {% elif chart.chart_type == 'pie' %}ğŸ¥§
                            {% elif chart.chart_type == 'doughnut' %}ğŸ©
                            {% elif chart.chart_type == 'histogram' %}ğŸ“‹
                            {% else %}ğŸ“Š{% endif %}
                        </div>
                        <p class="text-gray-400 text-sm">
                            {{ chart.x_column }}{% if chart.y_column %} Ã— {{ chart.y_column }}{% endif %}
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                        Created {{ chart.created_at|date:"M d, H:i" }}
                    </div>
                    <div class="flex space-x-2">
                        <a href="{% url 'dashboard' chart.session.id %}" 
                           class="text-sm text-neon-blue hover:text-neon-purple transition-colors">
                            View Dashboard
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-20">
            <div class="text-6xl mb-6 opacity-30">ğŸ“Š</div>
            <h3 class="text-2xl font-bold mb-4">No Charts Yet</h3>
            <p class="text-gray-400 mb-8">Create your first visualization to start building your collection</p>
            <a href="/" 
               class="px-8 py-3 bg-gradient-to-r from-neon-blue to-neon-purple rounded-lg font-bold text-lg hover:scale-105 transition-transform duration-300">
                Create First Chart â†’
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4">
    <div class="gradient-bg rounded-2xl p-8 max-w-md w-full">
        <h3 class="text-2xl font-bold mb-4 text-red-400">Delete Chart</h3>
        <p class="text-gray-300 mb-6" id="deleteMessage">
            Are you sure you want to delete this chart? This action cannot be undone.
        </p>
        
        <div class="flex justify-end space-x-4">
            <button onclick="hideDeleteModal()" 
                    class="px-6 py-2 gradient-bg rounded-lg hover:bg-gray-800 transition-colors duration-300">
                Cancel
            </button>
            <button onclick="confirmDelete()" 
                    class="px-6 py-2 bg-red-500 rounded-lg font-bold hover:bg-red-600 transition-colors duration-300">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div id="successToast" class="fixed top-4 right-4 bg-green-500/90 text-white px-6 py-3 rounded-lg shadow-lg hidden z-50">
    <div class="flex items-center">
        <span class="text-xl mr-3">âœ“</span>
        <span id="toastMessage">Chart deleted successfully!</span>
    </div>
</div>

<script>
    let chartToDelete = null;
    let chartTitleToDelete = '';
    
    // Filter functionality
    document.getElementById('sessionFilter').addEventListener('change', filterCharts);
    document.getElementById('typeFilter').addEventListener('change', filterCharts);
    
    function filterCharts() {
        const sessionFilter = document.getElementById('sessionFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const chartCards = document.querySelectorAll('.chart-card');
        
        chartCards.forEach(card => {
            const sessionMatch = !sessionFilter || card.dataset.session === sessionFilter;
            const typeMatch = !typeFilter || card.dataset.type === typeFilter;
            
            if (sessionMatch && typeMatch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    function clearFilters() {
        document.getElementById('sessionFilter').value = '';
        document.getElementById('typeFilter').value = '';
        filterCharts();
    }
    
    // Delete functionality
    function showDeleteModal(chartId, chartTitle) {
        chartToDelete = chartId;
        chartTitleToDelete = chartTitle;
        document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${chartTitle}"? This action cannot be undone.`;
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteModal').classList.add('flex');
    }
    
    function hideDeleteModal() {
        chartToDelete = null;
        chartTitleToDelete = '';
        document.getElementById('deleteModal').classList.remove('flex');
        document.getElementById('deleteModal').classList.add('hidden');
    }
    
    async function confirmDelete() {
        if (!chartToDelete) return;
        
        try {
            const response = await fetch(`/delete-chart/${chartToDelete}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Remove the chart card from DOM
                const chartCard = document.querySelector(`[data-session][onclick*="${chartToDelete}"]`);
                if (chartCard) {
                    chartCard.remove();
                } else {
                    // Fallback: remove any card that might contain this chart
                    const cards = document.querySelectorAll('.chart-card');
                    cards.forEach(card => {
                        if (card.querySelector(`button[onclick*="${chartToDelete}"]`)) {
                            card.remove();
                        }
                    });
                }
                
                // Update count
                const totalElement = document.querySelector('p.text-gray-400');
                if (totalElement) {
                    const match = totalElement.textContent.match(/(\d+)/);
                    if (match) {
                        const currentCount = parseInt(match[1]);
                        const newCount = Math.max(0, currentCount - 1);
                        totalElement.textContent = `${newCount} chart${newCount !== 1 ? 's' : ''} created`;
                    }
                }
                
                showToast('Chart deleted successfully!');
            } else {
                alert('Error: ' + (data.error || 'Failed to delete chart'));
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Network error: ' + error.message);
        }
        
        hideDeleteModal();
    }
    
    function showToast(message) {
        const toast = document.getElementById('successToast');
        const messageEl = document.getElementById('toastMessage');
        
        messageEl.textContent = message;
        toast.classList.remove('hidden');
        
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideDeleteModal();
        }
    });
</script>
{% endblock %}